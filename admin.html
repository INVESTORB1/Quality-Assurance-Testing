<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - User Management</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6fb; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #1a73e820; padding: 2rem; }
    h1 { color: #1a73e8; }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
    th, td { padding: 0.7rem; border: 1px solid #b6c6e3; text-align: left; }
    th { background: #e3eafc; }
    tr:nth-child(even) { background: #f8faff; }
    .approve-btn { background: #1a73e8; color: #fff; border: none; padding: 0.4rem 1rem; border-radius: 5px; cursor: pointer; }
    .approve-btn:disabled { background: #b6c6e3; cursor: not-allowed; }
    .create-user-form { margin-top: 2rem; padding: 1rem; background: #f8faff; border-radius: 8px; }
    .create-user-form input { margin-right: 1rem; padding: 0.5rem; border-radius: 4px; border: 1px solid #b6c6e3; }
    .create-user-form button { background: #174ea6; color: #fff; border: none; padding: 0.5rem 1.2rem; border-radius: 5px; cursor: pointer; }
    #adminMessage { margin-top: 1rem; font-size: 1rem; }
  </style>
</head>
<body>
  <!-- DEV OVERRIDE: force local backend for testing. Remove this line in production if you want to use the deployed API. -->
  <script>window.API_BASE = window.API_BASE || 'http://localhost:4000';</script>
  <script src="api-config.js"></script>
  <div class="container" style="display:flex;gap:2rem;min-height:600px;">
    <aside style="width:210px;background:#e3eafc;border-radius:10px;padding:2rem 1rem 2rem 1rem;box-shadow:0 2px 12px #1a73e810;display:flex;flex-direction:column;gap:1.5rem;">
      <button class="tab-btn" data-tab="welcome" style="padding:0.8rem 1rem;border:none;border-radius:6px;background:#1a73e8;color:#fff;font-weight:700;cursor:pointer;">Welcome</button>
      <button class="tab-btn" data-tab="pending" style="padding:0.8rem 1rem;border:none;border-radius:6px;background:#e3eafc;color:#1a73e8;font-weight:700;cursor:pointer;">Pending Approval</button>
      <button class="tab-btn" data-tab="create" style="padding:0.8rem 1rem;border:none;border-radius:6px;background:#e3eafc;color:#1a73e8;font-weight:700;cursor:pointer;">User Creation</button>
  <button class="tab-btn" data-tab="messages" style="padding:0.8rem 1rem;border:none;border-radius:6px;background:#e3eafc;color:#1a73e8;font-weight:700;cursor:pointer;">Messages</button>
  <button class="tab-btn" data-tab="userlist" style="padding:0.8rem 1rem;border:none;border-radius:6px;background:#e3eafc;color:#1a73e8;font-weight:700;cursor:pointer;">User List</button>
  <button class="tab-btn" data-tab="pwreset" style="padding:0.8rem 1rem;border:none;border-radius:6px;background:#e3eafc;color:#1a73e8;font-weight:700;cursor:pointer;">Password Reset</button>
  <button class="tab-btn" data-tab="activity" style="padding:0.8rem 1rem;border:none;border-radius:6px;background:#e3eafc;color:#1a73e8;font-weight:700;cursor:pointer;">User Activity</button>
    </aside>
    <main id="tabContent" style="flex:1;min-width:0;"></main>
  </div>
  <script>
    // --- Admin auth UI ---
    function showLogin() {
      if (document.getElementById('adminLoginOverlay')) return;
      const ov = document.createElement('div');
      ov.id = 'adminLoginOverlay';
      ov.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
      ov.innerHTML = `<div style='background:#fff;padding:2rem;border-radius:8px;min-width:320px;box-shadow:0 8px 32px rgba(0,0,0,0.2)'><h3 style='margin-top:0;color:#1a73e8'>Admin Login</h3><input id='adminPass' type='password' placeholder='Enter admin password' style='width:100%;padding:0.6rem;margin-bottom:0.6rem;border:1px solid #ccc;border-radius:4px' /><div style='display:flex;gap:0.5rem;justify-content:flex-end'><button id='adminLoginBtn' style='background:#1a73e8;color:#fff;border:none;padding:0.6rem 1rem;border-radius:4px;cursor:pointer'>Login</button></div><div id='adminLoginMsg' style='margin-top:0.6rem;color:red;display:none;'></div></div>`;
      document.body.appendChild(ov);
      document.getElementById('adminLoginBtn').addEventListener('click', async () => {
        const pass = document.getElementById('adminPass').value;
        document.getElementById('adminLoginMsg').style.display = 'none';
        try {
          const res = await fetch(`${window.API_BASE || 'http://localhost:4000'}/admin/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pass }) });
          if (!res.ok) {
            document.getElementById('adminLoginMsg').textContent = 'Invalid password';
            document.getElementById('adminLoginMsg').style.display = 'block';
            return;
          }
          const data = await res.json();
          localStorage.setItem('admin_token', data.token);
          document.body.removeChild(ov);
          // initialize admin UI after successful login
          initAdminUI();
        } catch (err) {
          document.getElementById('adminLoginMsg').textContent = 'Network error';
          document.getElementById('adminLoginMsg').style.display = 'block';
        }
      });
    }

    function requireAuthOrShow() {
      const token = localStorage.getItem('admin_token');
      if (!token) {
        showLogin();
        return false;
      }
      return true;
    }

    async function apiFetch(path, opts = {}) {
      opts.headers = opts.headers || {};
      const token = localStorage.getItem('admin_token');
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(`${window.API_BASE || 'http://localhost:4000'}${path}`, opts);
      if (res.status === 401) {
        // invalid token, prompt for login
        localStorage.removeItem('admin_token');
        showLogin();
        throw new Error('Unauthorized');
      }
      return res;
    }

    // --- User Activity Tab ---
    async function renderUserActivity() {
      const tabContent = document.getElementById('tabContent');
      tabContent.innerHTML = `<h2>User Activity Log</h2><div id='activityTableWrap' style='overflow-x:auto;'></div>`;
      const wrap = document.getElementById('activityTableWrap');
      try {
  if (!requireAuthOrShow()) return;
  const res = await apiFetch('/admin/interactions');
    const interactions = await res.json();
        if (!interactions.length) {
          wrap.innerHTML = '<p style="margin-top:2rem;">No user activity recorded yet.</p>';
          return;
        }
        let html = `<table style='width:100%;margin-top:1.5rem;'><thead><tr><th>Type</th><th>Name</th><th>Email</th><th>Subject</th><th>Message</th><th>Time</th></tr></thead><tbody>`;
        interactions.slice().reverse().forEach(act => {
          html += `<tr><td>${act.type}</td><td>${act.name || ''}</td><td>${act.email || ''}</td><td>${act.subject || ''}</td><td>${act.message || ''}</td><td>${act.timestamp ? new Date(act.timestamp).toLocaleString() : ''}</td></tr>`;
        });
        html += '</tbody></table>';
        wrap.innerHTML = html;
      } catch (err) {
        wrap.innerHTML = '<p style="color:red;">Failed to load activity log.</p>';
      }
    }

    // Tab switching logic
    document.addEventListener('DOMContentLoaded', function() {
      // Delay initializing admin UI until authenticated
      // Attach click handlers but don't render content until login succeeds
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => btn.addEventListener('click', function() {
        tabBtns.forEach(b => { b.style.background = '#e3eafc'; b.style.color = '#1a73e8'; });
        this.style.background = '#1a73e8';
        this.style.color = '#fff';
        showTab(this.dataset.tab);
      }));
      // Immediately prompt for admin login on page load
      showLogin();
    });

    // After successful login this function will initialize the default view
    function initAdminUI() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      // Set default active tab and render
      tabBtns[0].style.background = '#1a73e8';
      tabBtns[0].style.color = '#fff';
      showTab('welcome');
    }

    function showTab(tab) {
      const tabContent = document.getElementById('tabContent');
      if (tab === 'welcome') {
        tabContent.innerHTML = `<h1 style='color:#1a73e8;'>Welcome, Admin!</h1><p style='font-size:1.2rem;margin-top:1.5rem;'>Use the sidebar to manage users, approve pending accounts, or view messages sent from the contact page.</p>`;
      } else if (tab === 'pending') {
        renderPendingApproval();
      } else if (tab === 'create') {
        renderUserCreation();
      } else if (tab === 'messages') {
        renderMessages();
      } else if (tab === 'userlist') {
        renderUserList();
      } else if (tab === 'activity') {
        renderUserActivity();
      }
    }
    // --- User List Tab ---
    async function renderUserList() {
      const tabContent = document.getElementById('tabContent');
      tabContent.innerHTML = `<h2>All Users</h2><div id='userListTableWrap' style='overflow-x:auto;'></div>`;
      const wrap = document.getElementById('userListTableWrap');
      try {
  if (!requireAuthOrShow()) return;
  const res = await apiFetch('/admin/users');
    const users = await res.json();
        if (!users.length) {
          wrap.innerHTML = '<p style="margin-top:2rem;">No users found.</p>';
          return;
        }
        let html = `<table style='width:100%;margin-top:1.5rem;'><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
        users.forEach(user => {
          html += `<tr><td>${user.name}</td><td>${user.email}</td><td>${user.status}</td><td><button class='approve-btn' style='background:#e53935;margin-right:6px;' onclick="deleteUser('${user.id}', this)">Delete</button><button class='approve-btn' style='background:#ffa000;color:#000;margin-right:6px;' onclick="deactivateUser('${user.id}', this)">Deactivate</button><button class='approve-btn' style='background:#4caf50;' onclick="openResetModal('${user.id}','${user.name}')">Reset PW</button></td></tr>`;
        });
        html += '</tbody></table>';
        wrap.innerHTML = html;
      } catch (err) {
        wrap.innerHTML = '<p style="color:red;">Failed to load users.</p>';
      }
    }

    // --- Pending Approval Tab ---
    async function renderPendingApproval() {
      tabContent.innerHTML = `<h2>Pending Approval</h2><table id='usersTable' style='width:100%;margin-top:1.5rem;'><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>`;
  if (!requireAuthOrShow()) return;
  const res = await apiFetch('/admin/users');
    const users = await res.json();
      const tbody = tabContent.querySelector('#usersTable tbody');
      users.forEach(user => {
        if (user.status === 'pending') {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.status}</td>
            <td>
              <button class='approve-btn' onclick='approveUser("${user.id}", this)'>Approve</button>
              <button class='approve-btn' style='background:#e53935;' onclick='rejectUser("${user.id}", this)'>Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      });
    }
    window.rejectUser = async function(id, btn) {
      btn.disabled = true;
  await apiFetch('/admin/reject', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
      renderPendingApproval();
    }
    window.approveUser = async function(id, btn) {
      btn.disabled = true;
  await apiFetch('/admin/approve', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
      renderPendingApproval();
    }

    // Delete user from user list or pending table
    window.deleteUser = async function(id, btn) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
      btn.disabled = true;
      try {
        const res = await apiFetch('/admin/reject', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
        if (!res.ok) {
          alert('Failed to delete user');
        }
      } catch (err) {
        alert('Network error, please try again');
      }
      // Refresh both lists
      renderUserList();
      renderPendingApproval();
    }

    // Deactivate user
    window.deactivateUser = async function(id, btn) {
      if (!confirm('Are you sure you want to deactivate this user?')) return;
      btn.disabled = true;
      try {
        if (!requireAuthOrShow()) return;
        const res = await apiFetch('/admin/deactivate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
        if (!res.ok) alert('Failed to deactivate user');
      } catch (err) {
        alert('Network error, please try again');
      }
      renderUserList();
      renderPendingApproval();
    }

    // Password reset modal (simple prompt)
    function openResetModal(id, name) {
      const ok = confirm(`Reset password for ${name}? Click OK to generate a temporary password or Cancel to enter one manually.`);
      if (!ok) {
        const manual = prompt('Enter new password (leave blank to cancel):');
        if (!manual) return;
        doPasswordReset(id, manual);
        return;
      }
      // generate temp password server-side and return it
      doPasswordReset(id, null);
    }

    async function doPasswordReset(id, newPassword) {
      try {
        if (!requireAuthOrShow()) return;
        const res = await apiFetch('/admin/reset-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, newPassword }) });
        // parse response safely: support JSON or plain text (some hosts return HTML error pages)
        let data = null;
        try {
          const ct = (res.headers.get && res.headers.get('content-type')) || '';
          if (ct.includes('application/json')) {
            data = await res.json();
          } else {
            const txt = await res.text();
            data = { __raw: txt };
          }
        } catch (parseErr) {
          // fallback to text
          try { data = { __raw: await res.text() }; } catch (e) { data = { __raw: 'unable to read response' }; }
        }
        if (res.ok) {
          if (data && data.tempPassword) {
            alert(`Password reset. Temporary password: ${data.tempPassword}`);
          } else if (data && data.__raw) {
            alert('Password reset. Server response: ' + data.__raw);
          } else {
            alert('Password reset successfully.');
          }
        } else {
          const msg = (data && data.error) ? data.error : (data && data.__raw) ? data.__raw : `Request failed (${res.status})`;
          alert(msg);
        }
      } catch (err) {
        // apiFetch throws 'Unauthorized' when a 401 is received
        console.error('Password reset failed', err);
        if (err && err.message === 'Unauthorized') {
          alert('Unauthorized â€” your session may have expired. Please login again.');
          return;
        }
        // show any other error message when available
        alert('Network error. Please try again.\nDetails: ' + (err && err.message ? err.message : 'unknown'));
      }
    }

    // Password Reset tab
    function renderPasswordReset() {
      const tabContent = document.getElementById('tabContent');
      tabContent.innerHTML = `<h2>Password Reset</h2><p>Select a user from the list below or enter an ID to reset password.</p><div id='pwResetWrap'></div>`;
      const wrap = document.getElementById('pwResetWrap');
      (async () => {
        try {
          if (!requireAuthOrShow()) return;
          const res = await apiFetch('/admin/users');
          const users = await res.json();
          if (!users.length) { wrap.innerHTML = '<p>No users found.</p>'; return; }
          let html = `<table style='width:100%;margin-top:1.5rem;'><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
          users.forEach(u => {
            html += `<tr><td>${u.name}</td><td>${u.email}</td><td>${u.status}</td><td><button class='approve-btn' onclick="openResetModal('${u.id}','${u.name}')">Reset Password</button></td></tr>`;
          });
          html += '</tbody></table>';
          wrap.innerHTML = html;
        } catch (err) {
          wrap.innerHTML = '<p style="color:red;">Failed to load users.</p>';
        }
      })();
    }

    // --- User Creation Tab ---
    function renderUserCreation() {
      tabContent.innerHTML = `<h2>Create New User</h2><form id='createUserForm' style='margin-top:1.2rem;display:flex;flex-direction:column;gap:1rem;max-width:400px;'><input type='text' id='newName' placeholder='Name' required><input type='email' id='newEmail' placeholder='Email' required><input type='password' id='newPassword' placeholder='Password' required><button type='submit' style='background:#174ea6;color:#fff;padding:0.7rem 0;border:none;border-radius:5px;font-weight:700;'>Create User</button><div id='adminMessage'></div></form>`;
      document.getElementById('createUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = document.getElementById('newName').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const password = document.getElementById('newPassword').value;
        const msgDiv = document.getElementById('adminMessage');
        msgDiv.textContent = '';
        try {
            if (!requireAuthOrShow()) return;
            const res = await apiFetch('/admin/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, email, password })
            });
            const data = await res.json();
            if (res.ok) {
              msgDiv.textContent = 'User created successfully!';
              msgDiv.style.color = 'green';
              document.getElementById('createUserForm').reset();
            } else {
              msgDiv.textContent = data.error || 'Failed to create user.';
              msgDiv.style.color = 'red';
            }
        } catch (err) {
            // apiFetch will have already shown login if unauthorized; show generic error
            msgDiv.textContent = err.message && err.message === 'Unauthorized' ? 'Unauthorized. Please login.' : 'Network error. Please try again.';
            msgDiv.style.color = 'red';
        }
      });
    }

    // --- Messages Tab ---
    async function renderMessages() {
      tabContent.innerHTML = `<h2>Contact Messages</h2><div id='messagesTableWrap' style='overflow-x:auto;'></div>`;
      const wrap = document.getElementById('messagesTableWrap');
      try {
  const res = await fetch(`${window.API_BASE || 'http://localhost:4000'}/messages`);
    const messages = await res.json();
        if (!messages.length) {
          wrap.innerHTML = '<p style="margin-top:2rem;">No messages received yet.</p>';
          return;
        }
        let html = `<table style='width:100%;margin-top:1.5rem;'><thead><tr><th>Name</th><th>Email</th><th>Subject</th><th>Message</th><th>Time</th></tr></thead><tbody>`;
        messages.forEach(msg => {
          html += `<tr><td>${msg.name}</td><td>${msg.email}</td><td>${msg.subject || ''}</td><td>${msg.message}</td><td>${new Date(msg.timestamp).toLocaleString()}</td></tr>`;
        });
        html += '</tbody></table>';
        wrap.innerHTML = html;
      } catch (err) {
        wrap.innerHTML = '<p style="color:red;">Failed to load messages.</p>';
      }
    }

    // Add GET /messages endpoint to backend for this to work

  // Default behavior handled inside DOMContentLoaded
  </script>
</body>
</html>
